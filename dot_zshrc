##### Powerlevel10k instant prompt (keep at the top) #############################################
# Initialization code that may require console input (password prompts, [y/n], etc.) must go
# above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

##### Oh-My-Zsh core ###########################################################################
export ZSH="$HOME/.oh-my-zsh"

# Treat Zed (and any non-interactive shell) as headless: no prompts, no compfix interactivity.
# These must be set BEFORE sourcing oh-my-zsh.sh.
if [[ "$TERM_PROGRAM" == "zed" || ! -o interactive ]]; then
  export DISABLE_AUTO_UPDATE="true"       # OMZ: never prompt to update
  export DISABLE_UPDATE_PROMPT="true"     # OMZ (older var) for safety
  export ZSH_DISABLE_COMPFIX="true"       # Skip insecure completion dir prompts
  setopt NO_CHECK_JOBS                    # Don't block on background jobs at exit
  unsetopt SHARE_HISTORY                  # Avoid history file contention in headless runs
  export GIT_TERMINAL_PROMPT=0            # Never block on git credential prompts in headless runs
fi

# Theme choice (we’ll still override the prompt for Zed/VS Code below).
if [[ "$TERM_PROGRAM" == "vscode" || "$TERM_PROGRAM" == "zed" ]]; then
  ZSH_THEME="robbyrussell"
else
  ZSH_THEME="powerlevel10k/powerlevel10k"
fi

plugins=(git)
source "$ZSH/oh-my-zsh.sh"

##### Prompt / Theme ###########################################################################
# Minimal prompt in VS Code & Zed; full Powerlevel10k elsewhere
if [[ "$TERM_PROGRAM" == "vscode" || "$TERM_PROGRAM" == "zed" ]]; then
  PROMPT='%n@%m:%~%# '
  RPROMPT=''
else
  [[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh
fi

##### History setup ###########################################################################
HISTFILE="$HOME/.zhistory"
SAVEHIST=1000
HISTSIZE=999
setopt share_history
setopt hist_expire_dups_first
setopt hist_ignore_dups
setopt hist_verify

# Re-assert headless-safe options if inside Zed (or non-interactive).
if [[ "$TERM_PROGRAM" == "zed" || ! -o interactive ]]; then
  setopt NO_CHECK_JOBS
  unsetopt SHARE_HISTORY
fi

##### Interactive-only plugins & bindings ######################################################
# Load ZLE-dependent plugins only when truly interactive with a TTY.
if [[ -o interactive && -t 1 ]]; then
  # completion/navigation niceties
  bindkey '^[[A' history-search-backward
  bindkey '^[[B' history-search-forward

  # suggestions & highlighting (ZLE plugins)
  source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
  source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

  # zoxide (better cd) — only interactive to avoid surprising scripts
  eval "$(zoxide init zsh)"
  alias cd="z"

  # bun completions — completions are interactive-only
  [ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"
fi

##### Aliases & Tools #########################################################################
alias ls="eza --icons=always"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# LM Studio CLI
export PATH="$PATH:$HOME/.lmstudio/bin"

# pipx
export PATH="$PATH:$HOME/.local/bin"

# LLVM
export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
export LLVM_SYMBOLIZER_PATH="/opt/homebrew/opt/llvm/bin/llvm-symbolizer"

alias claude="~/.claude/local/claude"

# Put lazygit config in ~/.config/lazygit/config.yml
export XDG_CONFIG_HOME="$HOME/.config"

